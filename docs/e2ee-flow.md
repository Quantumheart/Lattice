# E2EE Process & User Interaction Flow

## High-Level Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APP STARTUP                              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Fresh     â”‚    â”‚ Restored     â”‚    â”‚ Restored Session      â”‚  â”‚
â”‚  â”‚ Login     â”‚    â”‚ + Stored Key â”‚    â”‚ No Stored Key         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                 â”‚                        â”‚              â”‚
â”‚       â–¼                 â–¼                        â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Sync +   â”‚    â”‚ Sync + Auto  â”‚    â”‚ Sync + Check          â”‚  â”‚
â”‚  â”‚ Check    â”‚    â”‚ Unlock       â”‚    â”‚ â†’ "Not set up"        â”‚  â”‚
â”‚  â”‚ Backup   â”‚    â”‚ â†’ Backed up  â”‚    â”‚                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                                          â”‚              â”‚
â”‚       â–¼                                          â–¼              â”‚
â”‚  User taps                              User taps "Chat backup" â”‚
â”‚  "Chat backup"                          in Settings             â”‚
â”‚       â”‚                                          â”‚              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                      â–¼                                          â”‚
â”‚              BootstrapDialog                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. Login & Sync Flow

```
User enters credentials
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MatrixService      â”‚
â”‚   .login()         â”‚
â”‚                    â”‚
â”‚ â€¢ Validate server  â”‚
â”‚ â€¢ Authenticate     â”‚
â”‚ â€¢ Cache password   â”‚  â† 5-min expiry timer
â”‚   (for UIA later)  â”‚
â”‚ â€¢ Store credentialsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _startSync()       â”‚     â”‚ First /sync response     â”‚
â”‚                    â”‚â”€â”€â”€â”€â–¶â”‚ arrives from server       â”‚
â”‚ await firstSync    â”‚     â”‚ (device keys, account     â”‚
â”‚                    â”‚     â”‚  data now available)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ checkChatBackupStatus()            â”‚
â”‚                                    â”‚
â”‚ getCryptoIdentityState() returns:  â”‚
â”‚   initialized: crossSigning +     â”‚
â”‚                keyBackup enabled?  â”‚
â”‚   connected:   secrets cached      â”‚
â”‚                locally?            â”‚
â”‚                                    â”‚
â”‚ chatBackupNeeded =                 â”‚
â”‚   !initialized || !connected       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ needed? â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    YES  â”‚        NO
    â–¼    â”‚        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”  (done â€” "Your keys are backed up")
â”‚ _tryAuto   â”‚
â”‚ Unlock()   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stored recovery key exists?                       â”‚
â”‚                                                   â”‚
â”‚  NO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    (silent return,            â”‚                   â”‚
â”‚     stays "Not set up")       â”‚                   â”‚
â”‚                               â”‚                   â”‚
â”‚  YES â”€â–¶ getCryptoIdentityStateâ”‚                   â”‚
â”‚         â”‚                     â”‚                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”              â”‚                   â”‚
â”‚    â”‚connected? â”‚              â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚                   â”‚
â”‚   YES   â”‚    NO               â”‚                   â”‚
â”‚   (skip)â”‚    â–¼                â”‚                   â”‚
â”‚    â”‚    â”‚ restoreCrypto       â”‚                   â”‚
â”‚    â”‚    â”‚  Identity()         â”‚                   â”‚
â”‚    â”‚    â”‚  (headless          â”‚                   â”‚
â”‚    â”‚    â”‚   bootstrap)        â”‚                   â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€         â”‚                   â”‚
â”‚    â”‚         â”‚                â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚                   â”‚
â”‚         â–¼                     â”‚                   â”‚
â”‚  checkChatBackupStatus()      â”‚                   â”‚
â”‚  (re-check after attempt)     â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Source:** `lib/services/matrix_service.dart` â€” `login()` (line 130), `_startSync()` (line 281), `_tryAutoUnlockBackup()` (line 361)

---

## 2. Bootstrap Dialog â€” State Machine

```
User taps "Chat backup: Not set up"
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   BootstrapDialog     â”‚
    â”‚   .show(context)      â”‚
    â”‚                       â”‚
    â”‚  â€¢ Create controller  â”‚
    â”‚  â€¢ Listen for UIA     â”‚
    â”‚  â€¢ Start bootstrap    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                  SDK Bootstrap State Machine                 â”‚
  â”‚                                                              â”‚
  â”‚  AUTO-ADVANCED (no user interaction needed):                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚ loading  â”œâ”€â–¶â”‚ askWipe    â”œâ”€â–¶â”‚ askSetupCrossSigning  â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Ssss       â”‚  â”‚ (spinner: "Setting    â”‚    â”‚
  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  up cross-signing")   â”‚    â”‚
  â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                            â”‚                â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚ askWipeOnlineKey     â”œâ”€â–¶â”‚ askSetupOnlineKeyBackup     â”‚  â”‚
  â”‚  â”‚  Backup              â”‚  â”‚ (spinner: "Setting up       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  online key backup")        â”‚  â”‚
  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                            â”‚                â”‚
  â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”         â”‚
  â”‚                           â”‚ New backup or existing?â”‚         â”‚
  â”‚                           â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜         â”‚
  â”‚                              â”‚                  â”‚            â”‚
  â”‚                    NEW SETUP â”‚     EXISTING     â”‚            â”‚
  â”‚                              â–¼                  â–¼            â”‚
  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚                    â”‚  askNewSsss  â”‚  â”‚ openExistingSsss â”‚    â”‚
  â”‚                    â”‚  (MANUAL)    â”‚  â”‚ (MANUAL)         â”‚    â”‚
  â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                           â”‚                   â”‚              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  "Save your recovery key"    â”‚        â”‚  "Enter recovery key"          â”‚
â”‚                              â”‚        â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ EsJt X7wK ... 4dQm     â”‚  â”‚        â”‚  â”‚ [___________________]    â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚        â”‚  â”‚  Recovery key input      â”‚  â”‚
â”‚  â”‚  [Copy to clipboard]   â”‚  â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚                                â”‚
â”‚                              â”‚        â”‚  â˜‘ Save key to this device     â”‚
â”‚  â˜‘ Save key to this device   â”‚        â”‚                                â”‚
â”‚                              â”‚        â”‚  â”€â”€â”€â”€â”€â”€â”€ or â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚                                â”‚
â”‚  â”‚ Cancel â”‚  â”‚ Next       â”‚  â”‚        â”‚  [Verify with another          â”‚
â”‚  â”‚        â”‚  â”‚ (disabled   â”‚  â”‚        â”‚      device]                   â”‚
â”‚  â”‚        â”‚  â”‚  until key  â”‚  â”‚        â”‚                                â”‚
â”‚  â”‚        â”‚  â”‚  copied or  â”‚  â”‚        â”‚  [Lost recovery key?]          â”‚
â”‚  â”‚        â”‚  â”‚  saved)     â”‚  â”‚        â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                     â”‚        â”‚        â”‚  â”‚ Cancel â”‚  â”‚ Unlock      â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
                      â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                                        â”‚
                      â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚              â”‚
                      â”‚         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                      â”‚         â”‚Valid key?â”‚
                      â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                      â”‚         NO   â”‚   YES
                      â”‚         â–¼    â”‚    â”‚
                      â”‚    "Invalid  â”‚    â”‚
                      â”‚     recovery â”‚    â”‚
                      â”‚     key"     â”‚    â”‚
                      â”‚              â”‚    â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                             â”‚            â”‚
                             â–¼            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”
                    â”‚      onDone()          â”‚
                    â”‚                        â”‚
                    â”‚ â€¢ Store recovery key   â”‚
                    â”‚   (if save checked)    â”‚
                    â”‚ â€¢ Cache SSSS secrets   â”‚
                    â”‚ â€¢ Self-sign device     â”‚
                    â”‚ â€¢ Update device keys   â”‚
                    â”‚ â€¢ Re-request keys for  â”‚
                    â”‚   undecryptable msgs   â”‚
                    â”‚ â€¢ Check backup status  â”‚
                    â”‚ â€¢ Clear cached passwordâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  "Backup complete"  â”‚
                    â”‚                     â”‚
                    â”‚   âœ… Success icon   â”‚
                    â”‚                     â”‚
                    â”‚  "Your chat backup  â”‚
                    â”‚   has been set up"  â”‚
                    â”‚                     â”‚
                    â”‚      [Done]         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                     Dialog closes,
                     Settings tile â†’
                     "Your keys are backed up"
```

**Source:** `lib/widgets/bootstrap_controller.dart` â€” state machine (line 149), `onDone()` (line 378); `lib/widgets/bootstrap_views.dart` â€” UI rendering; `lib/widgets/bootstrap_dialog.dart` â€” dialog orchestration

---

## 3. Device Verification (Alternative to Recovery Key)

```
User taps "Verify with another device"
    (from openExistingSsss view)
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KeyVerificationDialog               â”‚
â”‚                                      â”‚
â”‚  waitingAccept                       â”‚
â”‚  "Waiting for the other device       â”‚
â”‚   to accept..."                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚        â³ Spinner            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  askSas                              â”‚
â”‚  "Compare these emoji with the       â”‚
â”‚   other device"                      â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ¶  ğŸ”‘  ğŸµ  ğŸŒ  â¤ï¸  ğŸ”’  ğŸ‰   â”‚ â”‚
â”‚  â”‚  Dog Key Music Globe Heart Lock â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚
â”‚  [They don't match]  [They match]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
              â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
              â”‚ Match?  â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          NO   â”‚       â”‚  YES
          â–¼    â”‚       â”‚
     (cancel,  â”‚       â–¼
      return   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      to key   â”‚  â”‚ waitingSas       â”‚
      input)   â”‚  â”‚ "Verifying..."   â”‚
               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚           â”‚
               â”‚           â–¼
               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  â”‚ done                          â”‚
               â”‚  â”‚ "Device verified              â”‚
               â”‚  â”‚  successfully!"               â”‚
               â”‚  â”‚                               â”‚
               â”‚  â”‚ Wait for secrets to propagate â”‚
               â”‚  â”‚ (30s timeout on               â”‚
               â”‚  â”‚  onSecretStored stream)       â”‚
               â”‚  â”‚                               â”‚
               â”‚  â”‚         [Done]                â”‚
               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚             â”‚
               â”‚             â–¼
               â”‚   Bootstrap auto-finalized
               â”‚   via onDone()
               â”‚             â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼
                    Dialog closes
```

**Source:** `lib/widgets/key_verification_dialog.dart` â€” states (line 29), SAS auto-selection (line 56); `lib/widgets/bootstrap_dialog.dart` â€” `_showVerificationDialog()` (line 156)

---

## 4. UIA (User-Interactive Auth) During Bootstrap

```
Bootstrap needs server-side auth
(e.g., uploading cross-signing keys)
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MatrixService._handleUiaRequest  â”‚
â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Cached password     â”‚â”€â”€ YES â”€â”€â–¶ Auto-complete UIA
â”‚  â”‚ available?          â”‚          (user sees nothing)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚       NO  â”‚                      â”‚
â”‚           â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Forward to UI via          â”‚  â”‚
â”‚  â”‚ onUiaRequest stream        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  "Authentication required"       â”‚
â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Password: [____________] â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚
â”‚       [Cancel]    [Submit]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Source:** `lib/services/matrix_service.dart` â€” `_handleUiaRequest()` (line 215), `_setCachedPassword()` (line 261)

---

## 5. Settings â€” Backup Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SETTINGS SCREEN                                               â”‚
â”‚                                                                â”‚
â”‚  SECURITY                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â˜ï¸  Chat backup                                          â”‚  â”‚
â”‚  â”‚    â”œâ”€ "Checking..."             (null â€” loading)         â”‚  â”‚
â”‚  â”‚    â”œâ”€ "Not set up"              (true â€” tap â†’ Bootstrap) â”‚  â”‚
â”‚  â”‚    â””â”€ "Your keys are backed up" (false â€” tap â†’ Info)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”‚                              â”‚
    (Not set up)                  (Backed up)
         â”‚                              â”‚
         â–¼                              â–¼
  BootstrapDialog            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  (see Â§2 above)             â”‚  "Chat backup"      â”‚
                             â”‚                     â”‚
                             â”‚   âœ… Check icon     â”‚
                             â”‚                     â”‚
                             â”‚  "Your keys are     â”‚
                             â”‚   backed up and     â”‚
                             â”‚   accessible from   â”‚
                             â”‚   any device."      â”‚
                             â”‚                     â”‚
                             â”‚  [Disable backup]   â”‚
                             â”‚  [OK]               â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                              (Disable backup)
                                        â”‚
                                        â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚ "Disable chat        â”‚
                             â”‚  backup?"            â”‚
                             â”‚                      â”‚
                             â”‚ "You will lose       â”‚
                             â”‚  access to encrypted â”‚
                             â”‚  history on new      â”‚
                             â”‚  devices."           â”‚
                             â”‚                      â”‚
                             â”‚  [Cancel]  [Disable] â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                  (Disable)
                                        â”‚
                                        â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚ disableChatBackup()   â”‚
                             â”‚ â€¢ Delete backup from  â”‚
                             â”‚   server              â”‚
                             â”‚ â€¢ Delete stored       â”‚
                             â”‚   recovery key        â”‚
                             â”‚ â€¢ Set status â†’        â”‚
                             â”‚   "Not set up"        â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Source:** `lib/screens/settings_screen.dart` â€” backup tile (line 109), `_showBackupInfo()` (line 182), `_confirmDisableBackup()` (line 223)

---

## 6. Logout with Backup Warning

```
User taps "Sign Out"
        â”‚
        â–¼
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Backup enabled?â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   YES  â”‚       NO
   â”‚    â”‚        â”‚
   â”‚    â”‚        â–¼
   â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚  â”‚  âš ï¸  "Your encryption keys are  â”‚
   â”‚    â”‚  â”‚  not backed up. You will         â”‚
   â”‚    â”‚  â”‚  permanently lose access to      â”‚
   â”‚    â”‚  â”‚  your encrypted messages."       â”‚
   â”‚    â”‚  â”‚                                  â”‚
   â”‚    â”‚  â”‚  [Set up backup first]           â”‚
   â”‚    â”‚  â”‚  [Cancel]                        â”‚
   â”‚    â”‚  â”‚  [Sign Out] (red/error style)    â”‚
   â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚    â”‚             â”‚
   â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    â”‚    â”‚                   â”‚
   â”‚    â”‚ (setup)          (sign out)
   â”‚    â”‚    â”‚                   â”‚
   â”‚    â”‚    â–¼                   â”‚
   â”‚    â”‚  Bootstrap             â”‚
   â”‚    â”‚  Dialog                â”‚
   â”‚    â”‚                        â”‚
   â–¼    â”‚                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚ Standard logout â”‚               â”‚
â”‚ confirmation    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                 â”‚
â”‚ [Cancel]        â”‚
â”‚ [Sign Out]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   MatrixService.logout()
   â€¢ client.logout()
   â€¢ Clear all session keys
   â€¢ Clear cached password
   â€¢ Reset all state â†’ null
```

**Source:** `lib/screens/settings_screen.dart` â€” `_confirmLogout()` (line 254); `lib/services/matrix_service.dart` â€” `logout()` (line 183)

---

## Key Storage Map

```
FlutterSecureStorage
â”œâ”€â”€ lattice_access_token        â† session credential
â”œâ”€â”€ lattice_user_id             â† session credential
â”œâ”€â”€ lattice_homeserver          â† session credential
â”œâ”€â”€ lattice_device_id           â† session credential
â””â”€â”€ ssss_recovery_key_{userId}  â† recovery key (if "Save to device" checked)

In-Memory (MatrixService)
â”œâ”€â”€ _cachedPassword             â† login password (5-min TTL)
â”œâ”€â”€ _chatBackupNeeded           â† null | true | false
â””â”€â”€ _client.encryption          â† SDK manages cached SSSS secrets
```

**Source:** `lib/services/matrix_service.dart` â€” storage keys (line 316), recovery key (line 389), password caching (line 261)
